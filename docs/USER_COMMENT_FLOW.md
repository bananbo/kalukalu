# ユーザーコメント処理フロー

## 概要

ユーザーの YouTube Live コメントから生物を生成し、エコシステムシミュレーションに追加するフローを説明します。

---

## 処理フロー図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ユーザーコメント入力                                │
│  「赤くて速くて攻撃的な生物、でも群れで行動する」                              │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         1. コメント解析 (AI生成)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  入力: 自然言語のコメント                                                    │
│  出力:                                                                       │
│    - 属性パラメータ (speed, size, strength, intelligence, social)           │
│    - 外見設定 (bodyType, colors, eyes, wings, etc.)                         │
│    - 行動パターン (diet, activity, social)                                  │
│    - 動作プログラム (BehaviorProgram)                                       │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       2. パラメータバランス調整                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  全生物の合計点を均一化 (目標合計: 30点)                                     │
│                                                                              │
│  例: 速い (9) + 大きい (2) + 強い (7) + 賢い (6) + 社会性 (6) = 30           │
│                                                                              │
│  ※ 特徴を持たせつつ、トータルで公平な能力値に調整                            │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       3. 動作プログラム生成 (核心部分)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  BehaviorProgram = {                                                         │
│    approachAlly: 0.9,      // 同種族への接近 (群れ行動)                      │
│    approachEnemy: 0.7,     // 異種族への接近 (攻撃的)                        │
│    fleeWhenWeak: 0.3,      // 弱い時の逃走 (攻撃的なので低め)                │
│    aggressiveness: 0.9,    // 攻撃性 (攻撃的)                                │
│    curiosity: 0.5,         // 好奇心 (デフォルト)                            │
│    territoriality: 0.2     // 縄張り意識 (群れなので低め)                    │
│  }                                                                           │
│                                                                              │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        4. 生物オブジェクト生成                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Creature = {                                                                │
│    id: "creature-xxxxx",                                                     │
│    name: "レッドザウルス",                                                    │
│    attributes: { speed: 9, size: 2, strength: 7, ... },                      │
│    appearance: { primaryColor: "red", bodyType: "triangle", ... },           │
│    behavior: { diet: "carnivore", social: "pack", ... },                     │
│    behaviorProgram: { ... },  // ← AI生成の動作プログラム                    │
│    position: { x: 400, y: 300 },                                             │
│    energy: 100,                                                              │
│    species: "ユーザー名",    // コメント者 = 種族                            │
│    author: "ユーザー名",                                                     │
│    comment: "赤くて速くて..."                                                │
│  }                                                                           │
│                                                                              │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       5. エコシステムでの行動                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  calculateIntelligentMovement() で毎フレーム実行:                            │
│                                                                              │
│  周囲をスキャン (150px範囲)                                                  │
│      │                                                                       │
│      ├─ 同種族発見 → approachAlly に基づいて接近/離脱                       │
│      │                                                                       │
│      ├─ 異種族発見 → approachEnemy + 状況判断                               │
│      │    │                                                                  │
│      │    ├─ エネルギー低い → fleeWhenWeak で逃走判定                       │
│      │    ├─ 相手が弱い + aggressiveness高 → 攻撃的に接近                   │
│      │    └─ 相手が強い → 逃走                                              │
│      │                                                                       │
│      ├─ 何もいない → curiosity でランダム探索                               │
│      │                                                                       │
│      └─ territoriality → 初期位置に戻ろうとする力                          │
│                                                                              │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       6. 生存判定 (多種族との接触)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【戦闘発生条件】                                                            │
│    - 異種族同士が接触                                                        │
│    - 距離 < (自分のsize + 相手のsize) * 2.5                                 │
│                                                                              │
│  【戦闘力計算】                                                              │
│    power = strength * 0.5 + size * 0.3 + speed * 0.2                        │
│    + 食性ボーナス (肉食 vs 草食 = 1.5倍)                                    │
│                                                                              │
│  【ダメージ計算】                                                            │
│    damage = (相手power - 自分power * 0.5) * 5 / 10                          │
│    → エネルギーから減算                                                      │
│                                                                              │
│  【死亡条件】                                                                │
│    energy <= 0 で死亡                                                        │
│                                                                              │
│  ※ 時間経過ではなく、異種族との接触・戦闘が生存の鍵                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 動作プログラム (BehaviorProgram) 詳細

| パラメータ       | 範囲       | 説明                                       |
| ---------------- | ---------- | ------------------------------------------ |
| `approachAlly`   | -1.0 ~ 1.0 | 同種族への接近度。正で近づく、負で離れる   |
| `approachEnemy`  | -1.0 ~ 1.0 | 異種族への接近度。正で近づく、負で逃げる   |
| `fleeWhenWeak`   | 0.0 ~ 1.0  | エネルギーが低い時の逃走傾向               |
| `aggressiveness` | 0.0 ~ 1.0  | 攻撃性。高いと弱い敵に積極的に近づく       |
| `curiosity`      | 0.0 ~ 1.0  | 好奇心。高いとランダムに動き回る           |
| `territoriality` | 0.0 ~ 1.0  | 縄張り意識。高いと初期位置に留まろうとする |

---

## コメント → 動作プログラム変換例

### 例 1: 「攻撃的な肉食獣」

```
コメント: 「強くて攻撃的な肉食の生物」

生成されるBehaviorProgram:
{
  approachAlly: 0.5,       // 普通
  approachEnemy: 0.7,      // 敵に近づく（狩り）
  fleeWhenWeak: 0.3,       // あまり逃げない
  aggressiveness: 0.9,     // 非常に攻撃的
  curiosity: 0.5,          // 普通
  territoriality: 0.3      // 低め（狩りのため移動）
}
```

### 例 2: 「臆病な草食動物」

```
コメント: 「臆病で逃げ足が速い草食」

生成されるBehaviorProgram:
{
  approachAlly: 0.9,       // 仲間と一緒にいたい
  approachEnemy: -0.9,     // 敵から逃げる
  fleeWhenWeak: 0.9,       // すぐ逃げる
  aggressiveness: 0.1,     // 攻撃しない
  curiosity: 0.3,          // 慎重
  territoriality: 0.2      // 逃げるので低い
}
```

### 例 3: 「縄張り意識の強い守護者」

```
コメント: 「縄張りを守る防衛的な生物」

生成されるBehaviorProgram:
{
  approachAlly: 0.7,       // 仲間を守る
  approachEnemy: -0.5,     // 敵が来たら距離を取る
  fleeWhenWeak: 0.5,       // 状況次第
  aggressiveness: 0.4,     // 攻め込まない
  curiosity: 0.2,          // 縄張りから出ない
  territoriality: 0.9      // 非常に高い
}
```

### 例 4: 「好奇心旺盛な探索者」

```
コメント: 「好奇心が強く、いろんな所を探索する」

生成されるBehaviorProgram:
{
  approachAlly: 0.3,       // 単独行動気味
  approachEnemy: 0.0,      // 中立
  fleeWhenWeak: 0.6,       // 危険は避ける
  aggressiveness: 0.2,     // 攻撃より探索
  curiosity: 0.9,          // 非常に高い
  territoriality: 0.1      // どこでも行く
}
```

---

## キーワードマッピング

### 日本語キーワード

| キーワード         | 影響するパラメータ              |
| ------------------ | ------------------------------- |
| 攻撃、戦う、狩り   | aggressiveness↑, approachEnemy↑ |
| 臆病、逃げる、慎重 | fleeWhenWeak↑, approachEnemy↓   |
| 群れ、仲間、社会的 | approachAlly↑                   |
| 縄張り、守る、防衛 | territoriality↑                 |
| 好奇心、探索、冒険 | curiosity↑                      |
| 孤独、一匹狼       | approachAlly↓, territoriality↑  |

### 属性キーワード

| キーワード       | 影響する属性  |
| ---------------- | ------------- |
| 速い、早い、俊敏 | speed↑        |
| 大きい、巨大     | size↑         |
| 強い、力強い     | strength↑     |
| 賢い、知的       | intelligence↑ |

---

## 今後の改善点 (TODO)

1. **LLM API 統合**: 現在はキーワードベースだが、将来的には OpenAI/Anthropic API を使用してより高度な解析を行う

2. **動作プログラムの拡張**: より複雑な行動パターン（時間帯による行動変化、学習機能など）

3. **相性システム**: 特定の種族間の相性（天敵関係など）

4. **進化システム**: 生存した個体の動作プログラムを次世代に継承

---

## ファイル構成

```
server/
  services/
    creatureGenerator.ts   # コメント→生物変換（AI生成）
    youtubeLiveChat.ts     # YouTubeコメント取得

src/
  types/
    creature.ts            # 生物の型定義（BehaviorProgram含む）
  utils/
    ecosystemSimulation.ts # 戦闘・繁殖ロジック
    intelligentMovement.ts # 動作プログラムに基づく移動計算
```
